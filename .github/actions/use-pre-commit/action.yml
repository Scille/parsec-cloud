name: pre-commit
description: install & run-precommit

inputs:
  extra-args:
    description: options to pass to pre-commit run-precommit
    required: false
    default: ''
  check-all-files:
    description: Run `pre-commit` on all files
    required: false
    default: 'true'
  config-file:
    description: where is located the pre-commit config file
    required: false
    default: .pre-commit-config.yaml
  version:
    description: pre-commit version to use
    required: false
    default: 2.21.0

outputs:
  cache-hit:
    description: A boolean value to indicate an exact match was found for the key.
    value: ${{ steps.cache-pre-commit.outputs.cache-hit }}

runs:
  using: composite
  steps:
    - name: Cache pre-commit install
      id: cache-pre-commit
      uses: actions/cache@69d9d449aced6a2ede0bc19182fadc3a0a42d2b0 # pin v3.2.6
      with:
        key: pre-commit-${{ inputs.version }}-${{ hashFiles(inputs.config-file) }}
        path: |
          ~/.cache/pre-commit

    # Install pre-commit as a standalone .pyz archive that can be run by Python
    - name: Install pre-commit
      if: steps.cache-pre-commit.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/.cache/pre-commit/
        curl --proto '=https' --tlsv1.2 -sSL https://github.com/pre-commit/pre-commit/releases/download/v${{ inputs.version }}/pre-commit-${{ inputs.version }}.pyz > ~/.cache/pre-commit/pre-commit.pyz
      shell: bash

    - name: Debug installed python package
      run: |
        python --version
        python ~/.cache/pre-commit/pre-commit.pyz --version
      shell: bash

    - name: Retrieve the list of all changed files
      uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50  # pin v2.11.1
      if: ${{ inputs.check-all-files != 'true' }}
      id: changes
      with:
        list-files: shell
        filters: |
          all:
            - added|modified: '**'

    - name: Build pre-commit args
      id: pre-commit-args
      run: |
        # Build pre-commit args
        if [ '${{ inputs.check-all-files }}' != 'true' ]; then
          ARGS="--files $ALL_FILES $ARGS"
        else
          ARGS="--all-files $ARGS"
        fi
        echo "args=$ARGS" >> $GITHUB_OUTPUT
      env:
        ALL_FILES: ${{ steps.changes.outputs.all_files }}
        ARGS: ${{ inputs.extra-args }}
      shell: bash

    - name: Run pre-commit
      run: >-
        python
        ~/.cache/pre-commit/pre-commit.pyz
        run
        --verbose
        --show-diff-on-failure
        --color=always
        ${{ steps.pre-commit-args.outputs.args }}
      shell: bash
