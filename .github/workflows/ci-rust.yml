name: ci-rust

on:
  workflow_call:
  workflow_dispatch:

# We set `concurrency` to prevent having this workflow being run on code that is not up-to-date on a PR (a user make multiple push in a quick manner).
# But on the main branch, we don't want that behavior.
# Having the workflow run on each merge commit is something we would like, that could help us where a regression was made and missed by previous checks.
#
# For that we use `head_ref` that is only defined on `pull-request` and fallback to `run_id` (this is a counter, so it's value is unique between workflow call).
concurrency:
  group: ci-rust-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  cargo-exclude-unused-crates: >-
    --exclude=parsec
    --exclude=libparsec_bindings_android
    --exclude=libparsec_bindings_web
    --exclude=libparsec_bindings_electron
  # Cargo will be faster with this configuration.
  # It will only update it's index for the dependencies that we use.
  # https://blog.rust-lang.org/2023/03/09/Rust-1.68.0.html#cargos-sparse-protocol
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

permissions:
  contents: read

jobs:
  test-rust-matrix:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 🐧 Linux
            # All linux jobs must run the same ubuntu version to avoid Rust caching issues !
            os: ubuntu-20.04
          - name: 🍎 macOS
            os: macos-12
          - name: 🏁 Windows
            os: windows-2022
    name: "${{ matrix.name }}: 🦀 Rust tests"
    # Just a fail-safe timeout, see the fine grain per-task timeout instead
    timeout-minutes: 30
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # pin v3.5.2
        timeout-minutes: 5

      - uses: actions-rust-lang/setup-rust-toolchain@ac6bb38f317802fab2f463811237b0d9cba8cc80 # pin v1.4.4
        with:
          # We setup the cache by hand, see below
          cache: false
        timeout-minutes: 10

      - name: Retrieve Rust cache
        uses: Swatinem/rust-cache@6fd3edff6979b79f87531400ad694fb7f2c84b1f # pin v2.2.1
        with:
          # Cache is limited to 10Go (and cache is ~700mo per platform !). On top of that.
          # cache is only shared between master and the PRs (and not accross PRs).
          # So we only save the cache on master build given it's the ones that are the
          # most likely to be reused.
          save-if: ${{ github.ref == 'refs/heads/master' }}
        timeout-minutes: 5


      # Building OpenSSL requires a perl interpreter.
      # The default one does not provide windows-style filesystem
      # paths so we have to switch to Strawberry.
      - name: Use strawberry perl
        if: startsWith(matrix.os, 'windows')
        shell: bash
        run: echo OPENSSL_SRC_PERL=C:/Strawberry/perl/bin/perl >> $GITHUB_ENV
        timeout-minutes: 1

      # By default, `libparsec_crypto` uses Rust Crypto
      # so if we modify `libparsec_crypto` which are not tested, it will pass the CI,
      # that's why we add a check
      - name: Test rust codebase
        shell: bash
        run: |
          set -ex
          cargo check --profile ci-rust --workspace --features use-sodiumoxide
          cargo test --profile ci-rust --workspace ${{ env.cargo-exclude-unused-crates }}
          cargo test --profile ci-rust --package libparsec_crypto --features use-sodiumoxide
        timeout-minutes: 30
        env:
          RUST_LOG: debug

      # Clippy basically compile the project, hence it's faster to run it in
      # the test-rust-matrix job where compilation cache is reused !
      - uses: ./.github/actions/use-pre-commit
        if: startsWith(matrix.os, 'ubuntu-')
        with:
          extra-args: clippy --verbose
        timeout-minutes: 5

      - name: Check rust code format
        if: startsWith(matrix.os, 'ubuntu-')
        run: cargo fmt --check
        timeout-minutes: 2
