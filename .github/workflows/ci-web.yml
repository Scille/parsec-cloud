name: ci-web

on:
  workflow_call:
  workflow_dispatch:

# We set `concurrency` to prevent having this workflow being run on code that is not up-to-date on a PR (a user make multiple push in a quick manner).
# But on the main branch, we don't want that behavior.
# Having the workflow run on each merge commit is something we would like, that could help us where a regression was made and missed by previous checks.
#
# For that we use `head_ref` that is only defined on `pull-request` and fallback to `run_id` (this is a counter, so it's value is unique between workflow call).
concurrency:
  group: ci-web-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  # We use the version 18.12 because the version >= 18.13 have some breaking changes on how they format the date.
  # That would break our unit test if we don't update them.
  node-version: 18.12.0
  wasm-pack-version: 0.11.0
  # Cargo will be faster with this configuration.
  # It will only update it's index for the dependencies that we use.
  # https://blog.rust-lang.org/2023/03/09/Rust-1.68.0.html#cargos-sparse-protocol
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

permissions:
  contents: read
  packages: read

jobs:
  test-web-app:
    runs-on: ubuntu-22.04
    name: 🌐 Web tests
    # Just a fail-safe timeout, see the fine grain per-task timeout instead
    timeout-minutes: 20
    # Testbed server comes as a Docker image, so it will eventually goes out of sync
    # with the tests (typically a new API is introduced in the Parsec server, or a new
    # testbed template is introduced).
    # In such case, the container url should be updated from the, see:
    # https://github.com/Scille/parsec-cloud/pkgs/container/parsec-cloud%2Fparsec-testbed-server
    services:
      parsec-testbed-server:
        image: ghcr.io/scille/parsec-cloud/parsec-testbed-server:v2.15.0-dev.2023-06-07-sha.1058bbc
        ports:
          - 6777:6777
    steps:
      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # pin v3.5.3
        timeout-minutes: 5

      - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50  # pin v2.11.1
        id: changes
        with:
          filters: .github/filters/ci.yml

      - name: Check modified path that require `test-web` to run
        id: should-run-web-jobs
        if: >-
          steps.changes.outputs.web-jobs == 'true'
          || github.ref == 'refs/heads/master'
        run: echo "run=true" >> $GITHUB_OUTPUT
        shell: bash

      - uses: actions/setup-node@64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c  # pin v3.6.0
        if: steps.should-run-web-jobs.outputs.run == 'true'
        with:
          node-version: ${{ env.node-version }}
        timeout-minutes: 2

      - name: Install dependencies
        if: steps.should-run-web-jobs.outputs.run == 'true'
        run: |
          # Execute 'npm clean-install' until success,
          # This is done that way because sometime some CDN response with 503
          until npm clean-install; do
            echo "Failed clean-install, retrying ...";
          done
        working-directory: oxidation/client
        timeout-minutes: 5

      - name: Check lint
        if: steps.should-run-web-jobs.outputs.run == 'true'
        run: npm run lint
        working-directory: oxidation/client
        timeout-minutes: 5

      - name: Setup cache-key
        if: steps.should-run-web-jobs.outputs.run == 'true'
        id: cache-key
        run: >-
          echo "key=web-${{ hashFiles(
            'bindings/web/**',
            'libparsec/**',
            'rust-toolchain.toml',
            'Cargo.lock'
          ) }}-libparsec" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Restore libparsec if Rust hasn't been modified
        if: steps.should-run-web-jobs.outputs.run == 'true'
        id: cache-libparsec
        uses: actions/cache/restore@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # pin v3.3.1
        with:
          key: ${{ steps.cache-key.outputs.key }}
          path: |
            bindings/web/pkg/
            bindings/web/pkg/
        timeout-minutes: 2

      - name: Retrieve Rust cache
        uses: Swatinem/rust-cache@6fd3edff6979b79f87531400ad694fb7f2c84b1f # pin v2.2.1
        if: >-
          steps.should-run-web-jobs.outputs.run == 'true'
          && steps.cache-libparsec.outputs.cache-hit != 'true'
        with:
          # Cache is limited to 10Go (and cache is ~700mo per platform !). On top of that.
          # cache is only shared between master and the PRs (and not accross PRs).
          # So we only save the cache on master build given it's the ones that are the
          # most likely to be reused.
          save-if: ${{ github.ref == 'refs/heads/master' }}
        timeout-minutes: 5

      # Install wasm-pack command
      - uses: taiki-e/install-action@835cdc15ee7680334982c900847bcafb86487299 # pin v2.9.3
        with:
          tool: wasm-pack@${{ env.wasm-pack-version }}

      - name: Build web bindings
        if: >-
          steps.should-run-web-jobs.outputs.run == 'true'
          && steps.cache-libparsec.outputs.cache-hit != 'true'
        run: npm run build:dev
        working-directory: bindings/web
        timeout-minutes: 10

      - name: Save libparsec to be reuse later
        if: >-
          steps.should-run-web-jobs.outputs.run == 'true'
          && steps.cache-libparsec.outputs.cache-hit != 'true'
        uses: actions/cache/save@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # pin v3.3.1
        with:
          key: ${{ steps.cache-key.outputs.key }}
          path: |
            bindings/web/pkg/
            bindings/web/pkg/
        timeout-minutes: 2

      - name: Unit tests
        if: steps.should-run-web-jobs.outputs.run == 'true'
        run: npm run test:unit
        working-directory: oxidation/client
        timeout-minutes: 10

      - name: Check testbed server is running
        if: steps.should-run-web-jobs.outputs.run == 'true'
        run: curl http://localhost:6777

      - name: E2E tests
        if: steps.should-run-web-jobs.outputs.run == 'true'
        run: npm run test:e2e:headless
        env:
          TESTBED_SERVER_URL: parsec://localhost:6777?no_ssl=true
        working-directory: oxidation/client
        timeout-minutes: 10
