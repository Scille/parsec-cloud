<!-- Parsec Cloud (https://parsec.cloud) Copyright (c) BUSL-1.1 (eventually AGPL-3.0) 2016-present Scille SAS -->

<template>
  <ion-page>
    <ion-content
      :fullscreen="true"
      color="secondary"
    >
      <div id="container">
        <div class="logo">
          <img src="../assets/images/Logo/Logo/PNG/logo_blue.png">
        </div>
        <transition-group name="slide">
          <ion-card v-if="showOrganizationList">
            <ion-card-content class="organization-list">
              <ion-card-title color="tertiary">
                {{ $t('HomePage.organizationList.title') }}
              </ion-card-title>
              <ion-grid>
                <ion-row>
                  <ion-col
                    size="1"
                    v-for="device in deviceList"
                    :key="device.slug"
                  >
                    <ion-card
                      button
                      class="organization-card-container"
                      @click="onOrganizationCardClick(device)"
                    >
                      <ion-card-content>
                        <ion-grid>
                          <OrganizationCard :device="device"></OrganizationCard>
                          <ion-row>
                            <ion-col size="auto" v-if="getDeviceLocalStorageData(device.slug)">
                              {{ $t('HomePage.organizationList.organizationCard.lastLogin') }}
                              {{ $d(getDeviceLocalStorageData(device.slug).lastLogin, 'long') }}
                            </ion-col>
                          </ion-row>
                        </ion-grid>
                      </ion-card-content>
                    </ion-card>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
            <ion-card-content class="no-existing-organization">
              <ion-card-title color="tertiary">
                {{ $t('HomePage.noExistingOrganization.title') }}
              </ion-card-title>
              <ion-button
                @click="openCreateOrganizationModal()"
                size="large"
                id="create-organization-button"
              >
                <ion-icon
                  slot="start"
                  :icon="add"
                />
                {{ $t('HomePage.noExistingOrganization.createOrganization') }}
              </ion-button>
              <ion-button
                @click="openJoinByLinkModal()"
                fill="outline"
                size="large"
              >
                <ion-icon
                  slot="start"
                  :icon="link"
                />
                {{ $t('HomePage.noExistingOrganization.joinOrganization') }}
              </ion-button>
            </ion-card-content>
          </ion-card>
          <ion-card v-if="!showOrganizationList">
            <ion-card-content class="organization-list">
              <ion-card-title color="tertiary">
                <ion-button fill="clear" @click="showOrganizationList = !showOrganizationList">
                  <ion-icon slot="start" :icon="chevronBackOutline"></ion-icon>
                  {{ $t('HomePage.organizationLogin.backToList') }}
                </ion-button>
              </ion-card-title>
              <div id="login-container">
                <ion-card id="login-card-container">
                  <ion-card-content>
                    <ion-grid>
                      <OrganizationCard :device="selectedDevice"></OrganizationCard>
                      <PasswordInput :placeholder="''" :label="t('HomePage.organizationLogin.passwordLabel')"></PasswordInput>
                    </ion-grid>
                  </ion-card-content>
                </ion-card>
                <div id="login-button-container">
                  <ion-button @click="onLoginClicked(selectedDevice)">
                    <ion-icon slot="start" :icon="logIn"></ion-icon>
                    {{ $t("HomePage.organizationLogin.login") }}
                  </ion-button>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </transition-group>
      </div>
    </ion-content>
  </ion-page>
</template>

<script setup lang="ts">
import {
  IonAvatar,
  IonContent,
  IonPage,
  IonCard,
  IonCardContent,
  IonCardTitle,
  IonCardSubtitle,
  IonButton,
  IonIcon,
  IonRow,
  IonCol,
  IonGrid,
  isPlatform,
  modalController
} from '@ionic/vue';
import {
  add,
  link,
  chevronBackOutline,
  logIn
} from 'ionicons/icons'; // We're forced to import icons for the moment, see : https://github.com/ionic-team/ionicons/issues/1032
import { useI18n } from 'vue-i18n';
import { ref } from 'vue';
import JoinByLinkModal from '@/components/JoinByLinkModal.vue';
import CreateOrganization from '@/components/CreateOrganizationModal.vue';
import OrganizationCard from '@/components/OrganizationCard.vue';
import PasswordInput from '@/components/PasswordInput.vue';
import { createAlert } from '@/components/AlertConfirmation';
import { AvailableDevice } from '../plugins/libparsec/definitions';

const { t } = useI18n();
const deviceList: AvailableDevice[] = [
  {
    'organization_id': 'MegaShark',
    'human_handle': 'Maxime Grandcolas',
    'device_label': 'device_label',
    'key_file_path': 'key_file_path',
    'device_id': 'device_id',
    'slug': 'slug1',
    'ty': {'tag': 'Password'}
  },
  {
    'organization_id': 'Resana',
    'human_handle': 'Maxime Grandcolas',
    'device_label': 'device_label',
    'key_file_path': 'key_file_path',
    'device_id': 'device_id',
    'slug': 'slug2',
    'ty': {'tag': 'Password'}
  },
  {
    'organization_id': 'Oxymore',
    'human_handle': 'Maxime Grandcolas',
    'device_label': 'device_label',
    'key_file_path': 'key_file_path',
    'device_id': 'device_id',
    'slug': 'slug3',
    'ty': {'tag': 'Password'}
  },
  {
    'organization_id': 'Eddy',
    'human_handle': 'Maxime Grandcolas',
    'device_label': 'device_label',
    'key_file_path': 'key_file_path',
    'device_id': 'device_id',
    'slug': 'slug4',
    'ty': {'tag': 'Password'}
  }
];
let selectedDevice:AvailableDevice;
const showOrganizationList = ref(true);

export interface DeviceLocalStorageData {
    slug: string;
    lastLogin: Date;
}

const deviceLocalStorageDataList = [
  {slug: 'slug1', lastLogin: new Date()},
  {slug: 'slug2', lastLogin: new Date()},
  {slug: 'slug3', lastLogin: new Date()}
];

function getDeviceLocalStorageData(deviceSlug: string): DeviceLocalStorageData {
  return deviceLocalStorageDataList.find((device) => {
    return device.slug === deviceSlug;
  });
}

function onOrganizationCardClick(device: AvailableDevice): void {
  showOrganizationList.value = !showOrganizationList.value;
  selectedDevice = device;
}

function onLoginClicked(device: AvailableDevice): void {
  console.log('Log In!');
}

async function openJoinByLinkModal(): Promise<void> {
  const modal = await modalController.create({
    component: JoinByLinkModal,
    cssClass: 'join-by-link-modal'
  });
  modal.present();

  const { data, role } = await modal.onWillDismiss();

  if (role === 'confirm') {
    console.log(data);
  }
}

async function openCreateOrganizationModal(): Promise<void> {
  const modal = await modalController.create({
    component: CreateOrganization,
    canDismiss: canDismissModal
  });
  modal.present();

  const { data, role } = await modal.onWillDismiss();

  if (role === 'confirm') {
    console.log(data);
  }

}

async function canDismissModal(): Promise<boolean> {
  const alert = await createAlert(
    t('AlertConfirmation.areYouSure'),
    t('AlertConfirmation.infoNotSaved'),
    t('AlertConfirmation.cancel'),
    t('AlertConfirmation.ok')
  );

  await alert.present();

  const { role } = await alert.onDidDismiss();
  return role === 'confirm';
}
</script>

<style lang="scss" scoped>
#container {
  height: 100vh;
  display: flex;
  flex-direction: column;

  max-width: 50vw;
  margin: 0 auto;

  .logo {
    max-width: 10em;
    align-self: center;
    display: flex;
    align-items: end;
    padding-bottom: 2em;
    flex-basis: 25%;
    flex-grow: 0;
    flex-shrink: 0;
  }

  .slide-enter-active {
    transition: 0.5s ease-in-out;
    transition-delay: 0.5s;
  }

  .slide-leave-active {
    transition: 0.5s;
  }

  .slide-enter-from {
    opacity: 0;
    transform: translate(100%, 0);
  }

  .slide-leave-to {
    opacity: 0;
    transform: translate(-100%, 0);
  }

  .organization-list {
    padding: 3em;
    padding-bottom: 4em;

    ion-grid {
      --ion-grid-padding: 1em;
      --ion-grid-columns: 2;
    }

    .organization-card-container {
      background: #F9F9FB;
      margin: 1em 1.5em;
      user-select: none;

      ion-row {
        height: 2em;
      }

      &:hover {
        background: #E5F1FF;
        cursor: pointer;
      }
    }
  }

  .no-existing-organization {
    border-top: 1px solid #cce2ff;
    background: #fafafa;
    padding: 3em;
    padding-bottom: 4em;
  }

  #create-organization-button {
    margin-right: 1em;
  }
}

.lang-list {
  .item {
    ion-label {
      margin-left: 3.5em;
    }
  }
}

#login-container {
  margin-right: 3em;
  margin-left: 3em;
}

#login-card-container {
  background: #f9f9fb;
  border-radius: 8px;
  padding: 2em;
}

#login-button-container {
  text-align: right;
}
</style>
