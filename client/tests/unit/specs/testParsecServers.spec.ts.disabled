// Parsec Cloud (https://parsec.cloud) Copyright (c) BUSL-1.1 2016-present Scille SAS

// TODO: This test has been disabled since it now uses libparsec (which is only available
//       with e2e tests).
//       This test will be fixed (i.e. most likely moved into e2e tests) by
//       PR https://github.com/Scille/parsec-cloud/pull/11639

import { parseParsecAddr } from '@/parsec';
import { ServerType, getServerTypeFromParsedParsecAddr } from '@/services/parsecServers';
import { describe, expect, it } from 'vitest';

describe('Parsec Server detection', () => {
  it.each([
    ['parsec3://saas-v3.parsec.cloud:443', ServerType.Saas],
    ['parsec3://saas-v3.parsec.cloud', ServerType.Saas],
    ['parsec3://saas-v3.parsec.cloud:1337', ServerType.Custom],
    ['Parsec3://Saas-v3.Parsec.Cloud', ServerType.Saas],
    ['PARSEC3://SAAS-V3.PARSEC.CLOUD', ServerType.Saas],
    ['trial.parsec.cloud', ServerType.Custom],
    ['parsec3://trial.parsec.cloud', ServerType.Trial],
    ['parsec3://trial.parsec.cloud:443', ServerType.Trial],
    ['parsec3://my-server.com', ServerType.Custom],
    ['parsec3://my-server.com:1337', ServerType.Custom],
    ['parsec3://saas-v3.parsec.cloud?action=bootstrap_organization', ServerType.Saas],
    ['parsec3://saas-v3.parsec.cloud/myOrg?action=bootstrap_organization', ServerType.Saas],
    ['parsec3://saas-v3.parsec.cloud:443/myOrg?action=bootstrap_organization', ServerType.Saas],
    ['parsec3://saas-v3.parsec.cloud:1337/myOrg?action=bootstrap_organization', ServerType.Custom],
    ['parsec3://saas-demo-v3-mightyfairy.parsec.cloud', ServerType.Saas],
    ['parsec3://saas-demo-v3-mightyfairy.parsec.cloud:443', ServerType.Saas],
    ['parsec3://saas-demo-v3-mightyfairy.parsec.cloud:443/org', ServerType.Saas],
    ['parsec3://saas-demo-v3-mightyfairy.parsec.cloud:443/org', ServerType.Saas],
    ['parsec://saas-demo-v3-mightyfairy.parsec.cloud:443/org', ServerType.Saas],
  ])('Test getServerTypeFromAddress %s => %s', async (raw: string, expected: ServerType) => {
    const result = await parseParsecAddr(raw);
    if (!result.ok) {
      throw new Error(`Invalid test input \`${raw}\``);
    }
    const addr = result.value;
    expect(getServerTypeFromParsedParsecAddr(addr)).to.equal(expected);
  });
});
