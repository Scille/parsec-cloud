name: parsec-v3
base: core22
version: 3.0.0-a.0+dev
summary: Secure cloud framework
description: Parsec is an open-source cloud-based application that allow simple yet cryptographically secure file hosting.
grade: devel
confinement: classic
type: app

apps:
  parsec-v3:
    plugs:
      - desktop
      - desktop-legacy
      - home
      - wayland
      - x11
      - opengl
      - browser-support
      - network
      - gsettings
      - audio-playback
      - pulseaudio
      - password-manager-service
    desktop: usr/share/applications/parsec-v3.desktop
    command: command.sh

parts:
  libparsec:
    plugin: nil
    source: .
    build-packages:
      - python3
      - libssl-dev
      - libfuse3-dev
      - pkg-config
      - patchelf
    stage-packages:
      # libssl3 is provided by core22
      - fuse3
    build-snaps:
      - node/18/stable
    stage:
      - libparsec.d.ts
      - libparsec.node
      - bin # include fusermount bin
      - sbin # include mount.fuse, needed ?
      - lib # include libfuse3
    prime:
      - -libparsec.d.ts
      - -libparsec.node
    build-attributes:
      - enable-patchelf
    override-build: |
      set -x

      # Set system alias for python
      update-alternatives --install /usr/local/bin/python python $(which python3) 100

      # Install rust
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh /dev/stdin -y --default-toolchain none
      source "$HOME/.cargo/env"

      # Debug software versions
      node --version
      npm --version
      python --version
      cargo --version

      cd bindings/electron
      npm clean-install
      npm run build:release

      cp -va dist/libparsec/index.node "$CRAFT_PART_INSTALL/libparsec.node"
      cp -va dist/libparsec/index.d.ts "$CRAFT_PART_INSTALL/libparsec.d.ts"

  parsec:
    after:
      - libparsec
      - wrapper
    plugin: nil
    source: .
    build-snaps:
      - node/18/stable
    build-attributes:
      - enable-patchelf
    override-build: |
      set -x

      # Debug software versions
      node --version
      npm --version

      cd client
      npm clean-install
      npm run electron:copy

      cd electron
      npm clean-install

      # Copy bindings
      rm -rf build # Cleanup build folder
      mkdir -pv build/{src,generated-ts/src}
      cp -v "${CRAFT_STAGE}/libparsec.node" build/src/libparsec.node
      cp -v "${CRAFT_STAGE}/libparsec.d.ts" build/generated-ts/src/libparsec.d.ts

      # Compile typescript
      npx tsc

      # Package
      node package.js --mode prod --platform linux dir

      cp -vr dist/linux-unpacked "$CRAFT_PART_INSTALL"/app

  parsec-v3-desktop:
    plugin: nil
    source: client/electron/assets
    build-environment:
      - ICON_PATH: usr/share/icons/hicolor/512x512/apps/parsec-v3.png
      - DESKTOP_PATH: usr/share/applications/parsec-v3.desktop
      - PARSEC_SCHEME: parsec-v3
    stage:
      - "*"
    override-build: |
      mkdir -p $(dirname "$CRAFT_PART_INSTALL"/$ICON_PATH)
      cp -v icon.png "$CRAFT_PART_INSTALL"/$ICON_PATH

      mkdir -p $(dirname "$CRAFT_PART_INSTALL"/$DESKTOP_PATH)
      cat << EOF > "$CRAFT_PART_INSTALL"/$DESKTOP_PATH
      [Desktop Entry]
      Name=Parsec-v3
      Comment=Secure cloud framework
      Exec=\${SNAP}/command.sh %u
      Icon=\${SNAP}/$ICON_PATH
      Terminal=false
      Type=Application
      Categories=Office Network FileTransfer FileSystem Security
      MimeType=x-scheme-handler/$PARSEC_SCHEME;
      EOF

  electron-lib:
    plugin: nil
    stage-packages:
      - libgtk-3-0
      - libgbm1
      - libasound2
    build-attributes:
      - enable-patchelf

  wrapper:
    after:
      - electron-lib
    plugin: nil
    build-packages:
      - p7zip-full
    build-environment:
      # https://github.com/electron-userland/electron-builder-binaries/releases/snap-template-4.0-2
      - SNAP_TEMPLATE_URL: https://github.com/electron-userland/electron-builder-binaries/releases/download/snap-template-4.0-2/snap-template-electron-4.0-2-amd64.tar.7z
      # The checksum is provided in base64 format in the release page.
      - SNAP_TEMPLATE_SHA512: 3d8862410e4a1387b3ada2c4ed3393d9a14f1a404d8c72d137b0bca803da0ba55c9075371fed26f8903f5a6c7af377ca513d99070a3d329f3612e866428e5639
    build-attributes:
      - enable-patchelf
    stage:
      - "*"
    override-build: |
      set -x

      ARCHIVE_FILE=$(basename "$SNAP_TEMPLATE_URL")

      curl -L -O "$SNAP_TEMPLATE_URL"
      echo "${SNAP_TEMPLATE_SHA512}  $ARCHIVE_FILE" | sha512sum -c

      mkdir -v template
      7z x -so "$ARCHIVE_FILE" | tar --extract --file - --directory template

      cat > template/command.sh << EOF
      #!/bin/bash -e
      exec "\$SNAP/desktop-init.sh" "\$SNAP/desktop-common.sh" "\$SNAP/desktop-gnome-specific.sh" "\$SNAP/app/parsec-v3" "\$@" --no-sandbox
      EOF
      chmod a+x template/command.sh

      cp -rv template/. "$CRAFT_PART_INSTALL"
