MacOS installer for Parsec
==========================

Foreword
--------

To release an app on MacOS, even without dealing with the App Store, we must go through a few steps for the app to run on a user's Mac. Otherwise, the user might encounter warning messages while trying to open the app, or the app won't even launch at all because of Gatekeeper: https://en.wikipedia.org/wiki/Gatekeeper_(macOS)

1. __Build the app__: We use PyInstaller to compile Python code into an `.app` bundle. This is now done in the Github packaging CI.
2. __Sign the app__: Using an active Apple Developer account, we sign our code and its dependencies with a custom certificate created using the account.
3. __Notarize the app__: Notarizing the app is equivalent to asking Apple to approve it for distribution. Since MacOS 10.14.5, all applications downloaded outside of the App Store must be notarized to run. See https://developer.apple.com/documentation/xcode/notarizing_macos_software_before_distribution
4. __Staple the app__: An app notarization will be checked with an online request when a user tries to execute it. Stapling "attaches" the notarization to the app bundle itself, so that this check can be performed offline.
5. __Bundle into .dmg__: A nice format for distribution in MacOS is a `.dmg` bundle, which compresses the app and allows the user to simply drag and drop the app inside their `/Applications` folder.

Build steps
-----------

### 1 - Download the application

Download the `macOS-X64-installer` file generated by the packaging CI associated with the release commit, and extract the `Parsec.app` from it. The next steps will assume that the commands are executed from the folder `packaging/macOS` inside of which the app should be moved.


### 2 - Sign the application

```shell
$ codesign --deep --force -s <team-identity> --timestamp -v --entitlements entitlements.plist -o runtime parsec.app
```

`team-identity` being the signing certificate, to be downloaded with proper access here : https://developer.apple.com/account/resources/certificates/list
From PyInstaller versions >=4.4, the bundle will already be signed. To avoid notarization issues with this signature, the `--force` option is used to override it.

You can check the codesign using:
```shell
$ codesign -vvv --deep --strict parsec.app
```
The next step can only be successful if this check is.


### 3 - Zip and Notarize the app

A version of Xcode must be installed locally to use the following `xcrun notarytool` commands.

Going through this process for the first time, an application-specific password has to be generated here:
https://appleid.apple.com/account/manage
Your credentials can then be stored in the keychain for future authentications, with the same `team-identity` as in step 2:

```shell
$ xcrun notarytool store-credentials --apple-id "your-apple-id" --password "generated-password" --team-id "team-identity"
```

After which you can chose a `keychain profile name`.

The Apple ID is usually the email address used for the Apple account.

The app now has to be zipped to then be notarized using the ID and password:

```shell
$ ditto -c -k --keepParent "parsec.app" parsec.zip
$ xcrun notarytool submit parsec.zip --keychain-profile "keychain-profile-name"
```

While notarizing, you can check the progress using this command, using the `RequestUUID` received after uploading for notarization:

```shell
$ xcrun notarytool info <RequestUUID> --keychain-profile "keychain-profile-name"
```


### 4 - Staple the app

Once the notarization is done, we can staple the app:

```shell
$ xcrun stapler staple -v "parsec.app"
```


#### Check with Gatekeeper

Steps 3 and 4 exist to comply with Gatekeeper.
We can check if both steps were successful by asking Gatekeeper directly:

```shell
$ spctl --assess --type execute -vvv "parsec.app"
```


### 5 - Bundle into .dmg

The app is now ready to be bundled for distribution. To this end, we create a drag & drop `.dmg`.
This is automated through the `packaging/macOS/create_dmg.sh` script:

```shell
$ sh create_dmg.sh Parsec.app
```

The `parsec-vX.Y.Z-macos-amd64.dmg` bundle can then be uploaded in the corresponding release page.
